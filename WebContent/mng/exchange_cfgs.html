<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Exchange Settings</title>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<!-- Optional theme -->
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
<!-- Latest compiled and minified JavaScript -->

<link rel="stylesheet" href="http://cdn.datatables.net/1.10.0/css/jquery.dataTables.css">
<link rel="stylesheet" href="http://cdn.datatables.net/plug-ins/be7019ee387/integration/bootstrap/3/dataTables.bootstrap.css">

<link rel="stylesheet" href="../res/style.css">
</head>
<body>

	<!-- Fixed navbar navbar-fixed-top -->
	<div class="navbar navbar-default " role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
					<span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">MQueue Dispatcher</a>
			</div>
			<div class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li><a href="#">Home</a></li>
					<li><a href="server_cfgs.html">Server Settings</a></li>
					<li><a href="mqueue_cfgs.html">MQueue Settings</a></li>
					<li class="active"><a href="exchange_cfgs.html">Exchanges Settings</a></li>
					<li><a href="about.html">About</a></li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
				</ul>
			</div>
			<!--/.nav-collapse -->
		</div>
	</div>

	<div class="panel container">
		<div class="panel-heading">
			<button type="button" id="createBtn" class="btn btn-default btn-sm" onclick="createExchangeCfg()">create</button>
		</div>
		<div class="panel-body" id="tbl_container"></div>
	</div>

	<textarea id="template_xslt" style="display: none"> 
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">
	<xsl:template match="/">
<html>
<head>
</head>
<body>
		<table id="exchange_cfg_tbl">
			<thead>
				<tr>
					<th>id</th>
					<th>server user name</th>
					<th>exchange name</th>
					<th>type</th>
					<th>durable</th>
					<th>autoDelete</th>
					<th></th>
				</tr>
			</thead>
			<xsl:for-each select="exchangeCfgs/exchangeCfg">
				<tr data_id="{id}">
					<td><xsl:value-of select="id" /></td>
					<td><xsl:value-of select="serverCfg/userName" /></td>
					<td><xsl:value-of select="exchangeName" />	</td>
					<td><xsl:value-of select="type" /></td>
					<td><xsl:value-of select="durable" /></td>
					<td><xsl:value-of select="autoDelete" /></td>
					<td>
						<div class="btn-group">
						  <button type="button" id="editBtn" class="btn btn-default btn-sm" onclick="editExchangeCfg({id})">edit</button>
						  <button type="button" id="copyBtn" class="btn btn-default btn-sm" onclick="copyExchangeCfg({id})">copy</button>
						  <button type="button" id="deleteBtn" class="btn btn-default btn-sm">delete</button>
						</div>
					</td>
				
				</tr>
			</xsl:for-each>
			<tfoot>
				<tr>

				</tr>
			</tfoot>
		</table>
</body>
</html>
	</xsl:template>
</xsl:stylesheet>
	</textarea>
	
		<div class="modal fade" id="edit_modal_div">
		<div class="modal-dialog">
			<form class="form-horizontal" role="form" id="edit_form">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Edit Exchange</h4>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="exchangeName" class="col-sm-4 control-label">exchange name</label>
							<div class="col-sm-8">
								<input type="text" class="form-control" id="exchangeName" required="required">
							</div>
						</div>
						<div class="form-group">
							<label for="exchangeCfg" class="col-sm-4 control-label">Server</label>
							<div class="col-sm-8" id="serverCfg_select_div">
								
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-4 control-label">options</label>
							<div class="col-sm-8">
								<label class="checkbox-inline"> 
									<input type="checkbox" id="durable"> durable
								</label>  						
	  						
								<label class="checkbox-inline"> 
									<input type="checkbox" id="autoDelete"> autoDelete
								</label>  						
	  						</div>
						</div>
						
						<div class="form-group">
							<label for="type" class="col-sm-4 control-label">exchange type</label>
							<div class="col-sm-8">
								<label class="radio-inline">
								  <input type="radio" name="type" id="type_direct" value="direct"> direct
								</label>
								<label class="radio-inline">
								  <input type="radio" name="type" id="type_fanout" value="fanout"> fanout
								</label>
								<label class="radio-inline">
								  <input type="radio" name="type" id="type_topic" value="topic"> topic
								</label>
							</div>
						</div>	
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary" onclick="save(ExchangeCfg)">Save</button>
					</div>
					
				</div>
			</form>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>
	<!-- /.modal -->

	<script type="text/javascript" src="../res/jquery-2.1.1.js"></script>
	<script type="text/javascript" src="../res/jquery.xslt.js"></script>
	
	<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="http://cdn.datatables.net/1.10.0/js/jquery.dataTables.js"></script>
	<script type="text/javascript" src="http://cdn.datatables.net/plug-ins/be7019ee387/integration/bootstrap/3/dataTables.bootstrap.js"></script>
	
	<script type="text/javascript" src="/dispatcher-0.0.1/rest/v1/ajax" id="ajax_metadata"></script>
	<script type="text/javascript" src="../res/rest.js"></script>
	
	<script type="text/javascript">
		function newExchangeCfg(original) {
			var ExchangeCfg = null;
			if (original) {
				ExchangeCfg = $.extend({}, original);
				ExchangeCfg.id = -1;
			} else {
				ExchangeCfg = {"version":0,"id":-1,"exchangeName":null,"durable":true,"autoDelete":false,"type":"direct","serverCfg":null};
			}
			return ExchangeCfg;
		}
	
		function getExchangeCfg(idx) {
			if (!idx || idx < 0) {
				return newExchangeCfg();
			}
	
			var ExchangeCfg = null;
			var xhr = RS.ctx.ExchangeCfgRes.getJson.with_id(idx).call();
			if (xhr.statusCode().status != 200) {
				console.log(xhr);
				return;
			}
			ExchangeCfg = xhr.responseJSON;
			return ExchangeCfg;
		}
	
		function createExchangeCfg() {
			window.ExchangeCfg = null;
			window.ExchangeCfg = newExchangeCfg();
			fillForm(window.ExchangeCfg);
			$('#edit_modal_div').modal();
		}
		
		function editExchangeCfg(idx) {
			window.ExchangeCfg = null;
			window.ExchangeCfg = getExchangeCfg(idx);
			fillForm(window.ExchangeCfg);
			$('#edit_modal_div').modal();
		}
	
		function copyExchangeCfg(idx) {
			window.ExchangeCfg = null;
			window.ExchangeCfg = newExchangeCfg(getExchangeCfg(idx));
			fillForm(window.ExchangeCfg);
			$('#edit_modal_div').modal();
		}
	
		function fillForm(ec) {
			if (!ec)
				return;
			var ef = $("#edit_form");
	
			ef.find("#exchangeName").val(ec.exchangeName);
			ef.find("#durable").attr("checked", ec.durable);
			ef.find("#autoDelete").attr("checked", ec.autoDelete);
			ef.find("[name='type']").filter("[value='" + ec.type + "']").attr("checked", true);
			if (ec.serverCfg) {
				ef.find("#serverCfg").val(ec.serverCfg.id);
			}
		}
		
		function toEntity(ec) {
			var ef = $("#edit_form")[0];
	
			ec.exchangeName = ef["exchangeName"].value;
			ec.durable = ef["durable"].checked;
			ec.autoDelete = ef["autoDelete"].checked;
			ec.type = ef["type"].value;
			ec.serverCfg = {id: ef["serverCfg"].value};
			
			return ec;
		}
	
		function save(ExchangeCfg) {
			ExchangeCfg = toEntity(ExchangeCfg);
			var xhr = null; 
						
			if (ExchangeCfg.id < 0) {
				xhr = RS.ctx.ExchangeCfgRes.create.with_entity(JSON.stringify(ExchangeCfg)).call({async:false});	
			} else {
				xhr = RS.ctx.ExchangeCfgRes.update.with_entity(JSON.stringify(ExchangeCfg)).call({async:false});	
			}			
	
			if (xhr.statusCode().status != 200) {
				console.log(xhr);
				return;
			}
			
			var newExchangeCfg = xhr.responseJSON;
			updateTable();
			
			$('#edit_modal_div').modal('hide');
		}
		function updateTable() {
			loadData();
		}		

		function loadData() {

			var tx = $("#template_xslt")[0];
			var cd = $("#tbl_container");

			var xslt = tx.value.trim();
			var xhr = RS.ctx.ExchangeCfgRes.getAll.call().done(
					function(data, textStatus, jqXHR) {
						cd.xslt(jqXHR.responseText, xslt);
						$('#exchange_cfg_tbl').dataTable();
					});
			
			var xhr1 = RS.ctx.ServerCfgRes.getAll.call({async:false}).done(
					function(data, textStatus, jqXHR) {
						$("#serverCfg_select_div").xslt(
								jqXHR.responseText,
								"server_cfg_opts.xsl"
								);
					});
		}
		
		loadData();
	</script>
</body>
</html>